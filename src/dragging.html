<script>
	(function () {
		'use strict';

		function startDrag(e, prevState) {
			return {
			};
		}

		function getCartesian(e, prevState) {
			const bx = prevState.dxStart || 0;
			const by = prevState.dyStart || 0;
			return {
				dx: e.detail.dx + bx,
				dy: -(e.detail.dy + by)
			}
		}

		function drag(e, prevState) {
			const width = prevState.cardWidth;
			const height = width * 1.4; // depends on aspect ratio

			const {dx, dy} = getCartesian(e, prevState);

			const cx = width * 0.25; // depends on transform-origin
			const cy = height * 1.25; // depends on transform-origin

			const p = cy * dx / (cy + dy);
			const radians = Math.atan2(p, cy);

			const s = Math.tan(radians) * cx;
			const t = Math.cos(radians) * (dy + cy);
			const y = s + t - cy;

			const translate = `translateY(${-y}px)`;
			const rotate = `rotate(${radians}rad)`;

			return {
				transform: `${rotate} ${translate}`
			};
		}

		function stopDrag(e, prevState) {
			const {dx, dy} = getCartesian(e, prevState);
			return {
				dxStart: dx,
				dyStart: -dy
			};
		}

		window.Hx = window.Hx || {};
		window.Hx.move = function (event, prevState) {
			let state = {};
			switch (event.detail.state) {
				case 'start':
					state = startDrag(event, prevState);
					break;
				case 'track':
					state = drag(event, prevState);
					break;
				case 'end':
					state = stopDrag(event, prevState);
					break;
			}
			return Object.assign({}, prevState, state);
		}

	})();

</script>
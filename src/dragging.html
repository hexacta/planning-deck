<script>
	(function () {
		'use strict';

		function getCartesian(e, prevState) {
			const bx = prevState.dxStart || 0;
			const by = prevState.dyStart || 0;
			return {
				dx: e.detail.dx + bx,
				dy: -(e.detail.dy + by)
			}
		}

		function getPolar(e, prevState) {
			const width = prevState.cardWidth;
			const height = width * 1.4; // depends on aspect ratio

			const {dx, dy} = getCartesian(e, prevState);

			const cx = width * 0.25; // depends on transform-origin
			const cy = height * 1.25; // depends on transform-origin

			const p = cy * dx / (cy + dy);
			const radians = Math.atan2(p, cy);

			const s = Math.tan(radians) * cx;
			const t = Math.cos(radians) * (dy + cy);
			const y = s + t - cy;

			return {
				radius: y,
				angle: radians,
			};
		}

		function getTransform(polar) {
			const {radius, angle} = polar;

			const translate = `translateY(${-radius}px)`;
			const rotate = `rotate(${angle}rad)`;

			return `${rotate} ${translate}`;
		}

		function startDrag(e, prevState) {
			return {
			};
		}

		function drag(e, prevState) {
			const polars = getPolar(e, prevState);
			return {
				transform: getTransform(polars),
				transition: "",
			};
		}

		function stopDrag(e, prevState) {
			const {dx, dy} = getCartesian(e, prevState);
			const { angle } = getPolar(e, prevState);
			const transform = getTransform({ angle, radius: 0 });

			return {
				dxStart: dx,
				dyStart: -dy,
				transition: "transform 0.25s ease-in-out",
				transform: transform
			};
		}

		window.Hx = window.Hx || {};
		window.Hx.move = function (event, prevState) {
			let state = {};
			switch (event.detail.state) {
				case 'start':
					state = startDrag(event, prevState);
					break;
				case 'track':
					state = drag(event, prevState);
					break;
				case 'end':
					state = stopDrag(event, prevState);
					break;
			}
			return Object.assign({}, prevState, state);
		}

	})();

</script>
<link rel="import" href="coords.html">

<script>
	(function () {
		'use strict';

		function getPolar(e, prevState) {
			return Hx.coords.getPolar(
				prevState.cardHeight, 
				prevState.xStart, 
				prevState.yStart, 
				e.detail.dx, 
				e.detail.dy);
		}

		function getTransform(polar) {
			const {r, a, cy} = polar;
			const translate = `translateY(${cy - r}px)`;
			const rotate = `rotate(${(Math.PI / 2) - a}rad)`;
			return `${rotate} ${translate}`;
		}

		function startDrag(e, prevState) {
			return {
				transition: ""
			};
		}

		function drag(e, prevState) {
			const polar = getPolar(e, prevState);
			return {
				transform: getTransform(polar),
				transition: "",
			};
		}

		function stopDrag(e, prevState) {
			let {a, cy} = getPolar(e, prevState);
			const threshold = 7 * Math.PI / 16;
			const restAngle = 3 * Math.PI / 8 - (0.01 * prevState.index);
			a = a < threshold ? restAngle : Math.PI / 2;
			const rest = a < threshold ? "right" : "left";

			const transform = getTransform({ a, r: cy, cy: cy });
			const {x, y} = Hx.coords.toCartesian({ a, r: cy, cy: cy });

			return {
				xStart: x,
				yStart: y,
				transition: "transform 0.25s ease-in-out",
				transform: transform,
				rest: rest
			};
		}

		window.Hx = window.Hx || {};
		window.Hx.move = function (event, prevState) {
			let state = {};
			switch (event.detail.state) {
				case 'start':
					state = startDrag(event, prevState);
					break;
				case 'track':
					state = drag(event, prevState);
					break;
				case 'end':
					state = stopDrag(event, prevState);
					break;
			}
			return Object.assign({}, prevState, state);
		}

	})();

</script>
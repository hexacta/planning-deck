<link rel="import" href="coords.html">

<script>
	(function () {
		'use strict';

		function getPolar(e, prevState) {
			return Hx.coords.getPolar(
				prevState.cardHeight,
				prevState.xStart,
				prevState.yStart,
				e.detail.dx,
				e.detail.dy);
		}

		function getTransform(polar) {
			const {r, a, cy} = polar;
			const translate = `translateY(${cy - r}px)`;
			const rotate = `rotate(${(Math.PI / 2) - a}rad)`;
			return `${rotate} ${translate}`;
		}

		function startDrag(e, prevState) {
			return {
				transition: ""
			};
		}

		function polarDrag(e, prevState) {
			const polar = getPolar(e, prevState);
			return {
				transform: getTransform(polar)
			};
		}

		function cartesianDrag(e, prevState) {
			return {
				transform: `scale(1.4) translate(${e.detail.dx}px, ${e.detail.dy}px)`
			};
		}

		function stopDrag(e, prevState) {
			let {a, r, cy} = getPolar(e, prevState);

			let rest = prevState.rest;
			let restPolar = {};
			let endState = false;

			if (prevState.rest == "up") {
				const nr = cy + prevState.cardHeight * 1.10;
				rest = "middle";
				restPolar = { a: Math.PI / 2, r: nr, cy: cy };
				endState = {
					transform: "",
					transition: "transform 0.25s ease-in-out",
					transformOrigin: "25% 175%",
					zIndex: 0,
					endState: false,
					xStart: 0,
					yStart: cy,
				};
				
			} else if (prevState.rest != "up" && prevState.cardHeight * 0.35 < r - cy) {
				const nr = cy + prevState.cardHeight * 1.10;
				rest = "up";
				restPolar = { a: Math.PI / 2, r: nr, cy: cy };
				endState = {
					transform: "scale(1.4)",
					transition: "transform 0.25s ease-in-out",
					transformOrigin: "bottom",
					zIndex: 10,
					endState: false
				};
			} else if (prevState.rest == "middle") {
				const threshold = 15 * Math.PI / 32;
				const restAngle = 3 * Math.PI / 8 - (0.01 * prevState.index);
				a = a < threshold ? restAngle : Math.PI / 2;
				rest = a < threshold ? "right" : "middle";
				restPolar = { a, r: cy, cy: cy };
			} else if (prevState.rest == "right") {
				const threshold = 12 * Math.PI / 32;
				const restAngle = 3 * Math.PI / 8 - (0.01 * prevState.index);
				a = a < threshold ? restAngle : Math.PI / 2;
				rest = a < threshold ? "right" : "middle";
				restPolar = { a, r: cy, cy: cy };
			}

			const transform = getTransform(restPolar);
			const {x, y} = Hx.coords.toCartesian(restPolar);

			return {
				xStart: x,
				yStart: y,
				transition: "transform 0.25s ease-out",
				transform: transform,
				rest: rest,
				endState: endState
			};
		}

		window.Hx = window.Hx || {};
		window.Hx.move = function (event, prevState) {
			let state = {};
			switch (event.detail.state) {
				case 'start':
					state = startDrag(event, prevState);
					break;
				case 'track':
					state = prevState.rest == "up" ? cartesianDrag(event, prevState) : polarDrag(event, prevState);
					break;
				case 'end':
					state = stopDrag(event, prevState);
					break;
			}
			return Object.assign({}, prevState, state);
		}

	})();

</script>
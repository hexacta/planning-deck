<script>
	(function () {
		'use strict';

		function getCartesian(e, prevState) {
			const width = prevState.cardWidth;
			const height = width * 1.4; // depends on aspect ratio
			const cy = height * 1.25; // depends on transform-origin

			const bx = prevState.xStart || 0;
			const by = prevState.yStart || cy;

			return {
				x: bx + e.detail.dx,
				y: by - e.detail.dy
			}
		}

		function getCartesianFromPolar(polar) {
			return {
				x: polar.r * Math.cos(polar.a),
				y: polar.r * Math.sin(polar.a)
			}
		}

		function getPolar(e, prevState) {
			const {x, y} = getCartesian(e, prevState);
			return {
				r: Math.sqrt(x * x + y * y),
				a: Math.atan2(y, x)
			};
		}

		function getTransform(prevState, polar) {
			const width = prevState.cardWidth;
			const height = width * 1.4; // depends on aspect ratio
			const cy = height * 1.25; // depends on transform-origin
			const {r, a} = polar;

			const translate = `translateY(${cy - r}px)`;
			const rotate = `rotate(${(Math.PI / 2) - a}rad)`;
			return `${rotate} ${translate}`;
		}

		function startDrag(e, prevState) {
			return {
				transition: ""
			};
		}

		function drag(e, prevState) {
			const polar = getPolar(e, prevState);
			return {
				transform: getTransform(prevState, polar),
				transition: "",
			};
		}

		function stopDrag(e, prevState) {
			const width = prevState.cardWidth;
			const height = width * 1.4; // depends on aspect ratio
			const cy = height * 1.25; // depends on transform-origin

			let { a } = getPolar(e, prevState);
			const threshold = 7 * Math.PI / 16;
			const restAngle = 3 * Math.PI / 8;
			a = a < threshold ? restAngle : Math.PI / 2;

			const transform = getTransform(prevState, { a, r: cy });
			const {x, y} = getCartesianFromPolar({ a, r: cy });

			return {
				xStart: x,
				yStart: y,
				transition: "transform 0.25s ease-in-out",
				transform: transform
			};
		}

		window.Hx = window.Hx || {};
		window.Hx.move = function (event, prevState) {
			let state = {};
			switch (event.detail.state) {
				case 'start':
					state = startDrag(event, prevState);
					break;
				case 'track':
					state = drag(event, prevState);
					break;
				case 'end':
					state = stopDrag(event, prevState);
					break;
			}
			return Object.assign({}, prevState, state);
		}

	})();

</script>
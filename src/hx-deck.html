<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="hx-card.html">

<dom-module id="hx-deck">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        padding: 10px;
      }
      
      .deck {
        height: 350px;
        width: 250px;
        border: solid 2px red;
      }
      
      hx-card {
        position: absolute;
        transform-origin: bottom left;
        /*transition: transform 0.1s ease-in-out;*/
      }
    </style>

    <div class="deck" on-track="handleTrack">
      <template is="dom-repeat" items="[[cards]]">
        <hx-card>[[item]]</hx-card>
      </template>
    </div>
  </template>

  <script>
    class HxDeck extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'hx-deck'; }

      static get properties() {
        return {
          cards: {
            type: Array,
            value: () => [1, 2, 3, 4]
          }
        }
      }

      ready() {
        super.ready();
        this.currentIndex = this.cards.length;
      }

      get currentCard() {
        return this.shadowRoot.querySelector(`.deck hx-card:nth-child(${this.currentIndex})`);
      }

      handleTrack(e) {
        if (!this.currentIndex) return;
        switch (e.detail.state) {
          case 'start':
            this.cardWidth = this.currentCard.getBoundingClientRect().width;
            this.currentCard.style.transition = '';
            break;
          case 'track':
            this.move(e.detail.dx);
            break;
          case 'end':

            if (e.detail.dx < this.cardWidth / 2) {
              this.currentCard.style.transition = 'transform 0.5s ease-in-out';
              this.currentCard.style.transform = 'translateX(0px)';
            } else {
              this.currentCard.style.transition = 'transform 0.2s ease-in-out';
              this.currentCard.style.transform = 'translateX(50%) rotate(20deg)';
              this.currentIndex -= 1;
            }
            break;
        }
        e.preventDefault();
        e.stopPropagation();
      }

      move(dx) {
        if (dx < this.cardWidth / 2) {
          this.currentCard.style.transform = `translateX(${dx}px)`;
        } else {
          const hdx = dx - this.cardWidth / 2;
          const pdx = hdx / this.cardWidth;
          const rotation = pdx * 90;
          this.currentCard.style.transform = `translateX(50%) rotate(${rotation}deg)`;
        }
      }


    }

    window.requestAnimationFramePromise = _ => new Promise(requestAnimationFrame);
    window.customElements.define(HxDeck.is, HxDeck);
  </script>
</dom-module>